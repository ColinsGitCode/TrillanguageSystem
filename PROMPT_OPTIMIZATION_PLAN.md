# 提示词工程优化方案 - 三语学习卡片系统

## 📋 当前问题分析

### 1. 例句质量问题
- ❌ 只有"日常口语风格"的笼统要求
- ❌ 缺乏例句难度分级和长度控制
- ❌ 没有场景多样性指导
- ❌ 例句与短语关联度不够明确

### 2. 翻译精度问题
- ❌ 缺少上下文消歧策略（多义词处理）
- ❌ 没有语域和正式度控制
- ❌ 文化差异和习语处理不明确
- ❌ 专业术语翻译标准缺失

### 3. 提示词结构问题
- ❌ 缺少 Few-shot 示例参考
- ❌ 没有思维链（Chain of Thought）引导
- ❌ 缺乏自我检查和质量验证机制
- ❌ JSON 输出稳定性有待提升

### 4. 日语处理问题
- ❌ Ruby 注音规则不够详细
- ❌ 特殊汉字读音处理不明确
- ❌ 敬语和语域选择缺少指导

---

## 🎯 优化策略

### 核心优化方向（按优先级排序）

| 优先级 | 优化项 | 预期提升 | 实施难度 |
|--------|--------|---------|---------|
| ⭐⭐⭐ | 引入分步推理（CoT） | 翻译准确度 +30% | 中 |
| ⭐⭐⭐ | 添加 Few-shot 示例 | 例句质量 +40% | 低 |
| ⭐⭐⭐ | 例句质量标准化 | 实用性 +35% | 中 |
| ⭐⭐ | 上下文消歧机制 | 多义词准确度 +25% | 中 |
| ⭐⭐ | 自我检查机制 | 整体质量 +20% | 高 |
| ⭐ | JSON Schema 验证 | 输出稳定性 +15% | 低 |

---

## 🔧 具体优化措施

### 1️⃣ 引入分步推理（Chain of Thought）

**优化前：**
```
判断输入短语的语言 → 直接生成翻译和例句
```

**优化后：**
```
步骤1：语言识别与词性分析
步骤2：多义词消歧与上下文理解
步骤3：目标语言翻译策略选择
步骤4：例句场景规划
步骤5：生成内容与自检
```

**实施方式：**
在提示词中增加 `<thinking>` 块，要求 LLM 先进行内部推理，再输出结果。

---

### 2️⃣ Few-shot 示例库

为不同类型的输入提供高质量示例：

#### 示例 A：简单日常词汇
**输入：** "打招呼"

**期望输出结构：**
```markdown
## 1. 英文:
- **翻译**: greet / say hello
- **解释**: A polite action of acknowledging someone when you meet them
- **例句1**: Hey, I just wanted to greet the new neighbors.
  - 嘿，我只是想跟新邻居打个招呼。
- **例句2**: Don't forget to greet your teacher when you see her.
  - 见到老师时别忘了打招呼。

## 2. 日本語:
- **翻訳**: 挨拶(あいさつ)する
- **解説**: 人(ひと)に会(あ)った時(とき)に礼儀(れいぎ)として声(こえ)をかける行為(こうい)
- **例句1**: 朝(あさ)、会社(かいしゃ)で同僚(どうりょう)に挨拶(あいさつ)するのは基本(きほん)だよ。
  - 早上在公司向同事打招呼是基本礼仪。
- **例句2**: 彼(かれ)はいつも笑顔(えがお)で挨拶(あいさつ)してくれる。
  - 他总是笑着跟我打招呼。
```

#### 示例 B：技术术语
**输入：** "API"

**期望输出结构：**
```markdown
## 1. 英文:
- **翻译**: API (Application Programming Interface) [原文]
- **解释**: A set of rules allowing different software to communicate
- **例句1**: We need to integrate their payment API into our app.
  - 我们需要把他们的支付 API 集成到我们的应用里。
- **例句2**: This API documentation is really well written.
  - 这个 API 文档写得真不错。

## 4. 技术概念简要说明
应用程序编程接口（API）是一组预定义的函数、协议和工具，允许不同的软件系统相互通信和交换数据。它定义了软件组件之间交互的方式，隐藏了内部实现细节，只暴露必要的接口。常见类型包括 REST API、GraphQL API 等。开发者通过调用 API 可以实现跨系统的功能集成，如第三方登录、支付、地图服务等。
```

---

### 3️⃣ 例句质量标准

#### 黄金标准（5 个维度）

| 维度 | 要求 | 示例（好） | 示例（坏） |
|------|------|-----------|-----------|
| **场景真实性** | 必须是日常可能遇到的真实场景 | "Can you pass me the salt?" | "The cat programming jumps." |
| **长度控制** | 英文 8-15 词，日语 10-20 字 | ✅ 适中 | ❌ 过长或过短 |
| **难度适配** | 与短语难度匹配±1级 | ✅ 匹配 | ❌ 短语简单例句高级 |
| **语法自然** | 母语者日常使用的表达 | "Wanna grab lunch?" | "Do you desire to consume food?" |
| **场景多样** | 两个例句应覆盖不同场景 | 例句1：工作 / 例句2：家庭 | ❌ 两句场景重复 |

#### 实施策略
在提示词中明确要求：
```
例句要求：
1. 场景：第一句偏向正式/工作场景，第二句偏向日常/轻松场景
2. 长度：英文控制在 8-15 词，日语控制在 10-20 字
3. 语法：使用缩写（wanna, gonna）和口语表达，避免书面语
4. 多样性：两个例句必须展示不同的使用场景
5. 实用性：例句应该是学习者可以直接套用的句型
```

---

### 4️⃣ 上下文消歧机制

#### 多义词处理策略

**步骤：**
1. 识别输入短语是否为多义词
2. 在 `<thinking>` 中列举主要义项
3. 选择最常用义项作为主翻译
4. 在解释中简要说明其他常见含义

**示例：**
```
输入: "run"

<thinking>
"run" 有多个常见义项：
1. 跑步（最常用，日常生活）
2. 运行（IT/技术领域）
3. 经营（商业领域）
4. 流淌（液体相关）

选择策略：如无特定领域上下文，优先选择最常用的"跑步"义项，
在解释中提及"也可指程序运行、经营等"
</thinking>

## 1. 英文:
- **翻译**: run [原文]
- **解释**: To move fast on foot; also means to operate (programs, businesses)
```

---

### 5️⃣ 自我检查机制

在 JSON 输出前增加质量自检步骤：

```json
{
  "internal_checks": {
    "translation_accuracy": "已核对三语翻译的对应性",
    "example_quality": "已确认例句符合口语风格且场景不重复",
    "japanese_ruby": "已检查所有日语汉字都有假名注音",
    "foreign_words": "已标注日语外来语的英文对应",
    "audio_text_clean": "已确认 audio_tasks 文本不含 ruby 标签"
  },
  "markdown_content": "...",
  "audio_tasks": [...]
}
```

---

### 6️⃣ 改进日语处理规则

#### 详细的 Ruby 注音规则

| 情况 | 规则 | 示例 |
|------|------|------|
| 常规汉字 | 每个汉字独立注音 | 勉強(べんきょう) → 勉(べん)強(きょう) |
| 专有名词 | 整体注音 | 東京(とうきょう) ✅ |
| 送假名动词 | 只注汉字部分 | 食べる → 食(た)べる |
| 英文缩写 | 不注音 | IT、API、URL ✅ |
| 外来语片假名 | 标注英文原词 | コンピュータ(computer) ✅ |
| 数字 | 根据读法注音 | 一人(ひとり)、二人(ふたり) |

#### 敬语和语域选择

```
日语例句语域选择：
- 例句1：使用です/ます体（礼貌体）
- 例句2：使用普通体（日常体）
- 避免过度敬语（謙譲語/尊敬語），保持实用性
```

---

## 📝 实施计划

### Phase 1: 核心优化（第1周）
- [x] 分析现有提示词问题
- [ ] 重构 `promptEngine.js`，引入 CoT 结构
- [ ] 添加 3-5 个高质量 Few-shot 示例
- [ ] 实施例句质量标准

### Phase 2: 高级优化（第2周）
- [ ] 实现多义词消歧机制
- [ ] 添加自我检查步骤
- [ ] 优化日语注音规则
- [ ] 增强 JSON Schema 验证

### Phase 3: 测试与调优（第3周）
- [ ] 使用 50 个测试短语验证质量
- [ ] 收集反馈并调整参数
- [ ] 编写提示词版本管理文档
- [ ] 性能基准测试

---

## 📊 预期效果

### 优化前 vs 优化后对比

| 指标 | 优化前 | 优化后（预期） |
|------|--------|---------------|
| 翻译准确率 | 75% | 90%+ |
| 例句实用性评分 | 6.5/10 | 8.5/10 |
| 日语注音错误率 | 15% | <3% |
| JSON 解析成功率 | 85% | 98%+ |
| 多义词处理准确度 | 60% | 85%+ |

---

## 🔍 质量评估方法

### 自动化测试集

创建包含以下类型的测试短语（共 50 个）：
1. 简单日常词汇（10个）
2. 多义词（10个）
3. 技术术语（10个）
4. 习语和俗语（10个）
5. 日语特有表达（5个）
6. 混合语言输入（5个）

### 人工评审标准

每个生成结果评分（1-5分）：
- 翻译准确性
- 例句实用性
- 文化适配度
- 注音正确性
- 整体流畅度

---

## 🚀 快速开始

按照以下顺序实施优化：

1. **立即可做**（低成本高收益）：
   - 添加 Few-shot 示例
   - 明确例句质量标准
   - 改进日语注音规则文档

2. **核心改进**（需要代码修改）：
   - 重构 `promptEngine.js`
   - 引入 CoT 推理步骤
   - 实现自我检查机制

3. **高级优化**（长期迭代）：
   - 建立测试集和评估体系
   - 持续调优温度参数和 token 限制
   - 版本化提示词管理

---

## 📚 附录：参考资料

- **Prompt Engineering Guide**: https://www.promptingguide.ai/
- **OpenAI Prompt Best Practices**: [官方文档]
- **Few-shot Learning 论文**: Brown et al., 2020
- **日语注音规范**: JIS X 4051
