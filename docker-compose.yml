version: "3.9"
services:
  viewer:
    build: .
    container_name: trilingual-viewer
    depends_on:
      - ocr
      - tts-en
      - tts-ja
    environment:
      - PORT=3010
      - RECORDS_PATH=/data/trilingual_records
      - DB_PATH=/data/trilingual_records/trilingual_records.db
      - OCR_PROVIDER=tesseract
      - OCR_TESSERACT_ENDPOINT=http://ocr:8080/ocr
      - OCR_LANGS=eng+jpn+chi_sim
      - OCR_TIMEOUT_MS=20000
      - GEMINI_MODE=host-proxy
      - GEMINI_PROXY_URL=${GEMINI_PROXY_URL:-http://host.docker.internal:18888/api/gemini}
      - GEMINI_PROXY_AUTH_MODE=${GEMINI_PROXY_AUTH_MODE:-apikey}
      - GEMINI_PROXY_API_KEY=${GEMINI_PROXY_API_KEY:-}
      - GEMINI_PROXY_SOURCE_APP=${GEMINI_PROXY_SOURCE_APP:-tri-lang-learning-system}
      - GEMINI_PROXY_SOURCE_ENV=${GEMINI_PROXY_SOURCE_ENV:-prod}
      - GEMINI_PROXY_PROJECT=${GEMINI_PROXY_PROJECT:-tri-lang-learning-system}
      - GEMINI_PROXY_MODEL=${GEMINI_PROXY_MODEL:-gemini-3-pro-preview}
      - GEMINI_PROXY_REQUEST_TIMEOUT_MS=${GEMINI_PROXY_REQUEST_TIMEOUT_MS:-120000}
      - GEMINI_PROXY_EXECUTION_TIMEOUT_MS=${GEMINI_PROXY_EXECUTION_TIMEOUT_MS:-100000}
      - GEMINI_PROXY_PARAM_POLICY=${GEMINI_PROXY_PARAM_POLICY:-strict}
      - TTS_EN_ENDPOINT=http://tts-en:8000/v1/audio/speech
      - TTS_EN_TYPE=kokoro
      - TTS_EN_SPEED=1.0
      - TTS_EN_VOICE=af_bella
      - TTS_EN_MODEL=hexgrad/Kokoro-82M
      - HTML_RENDER_MODE=local
      - TTS_JA_ENDPOINT=http://tts-ja:50021
      - TTS_JA_TYPE=voicevox
      - VOICEVOX_SPEAKER=2
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-3-pro-preview}
      - ENABLE_GOLDEN_EXAMPLES=${ENABLE_GOLDEN_EXAMPLES:-false}
      - GOLDEN_EXAMPLES_STRATEGY=${GOLDEN_EXAMPLES_STRATEGY:-HIGH_QUALITY_GEMINI}
      - GOLDEN_EXAMPLES_COUNT=${GOLDEN_EXAMPLES_COUNT:-3}
      - GOLDEN_EXAMPLES_MIN_SCORE=${GOLDEN_EXAMPLES_MIN_SCORE:-85}
      - LLM_CONTEXT_WINDOW=${LLM_CONTEXT_WINDOW:-4096}
      - FEWSHOT_TOKEN_BUDGET_RATIO=${FEWSHOT_TOKEN_BUDGET_RATIO:-0.25}
    ports:
      - "3010:3010"
    volumes:
      - trilingual_records:/data/trilingual_records
      - .:/app
      - /app/node_modules # prevent overwriting container node_modules with host ones
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"

  ocr:
    build:
      context: ./ocr_service
    container_name: trilingual-ocr
    environment:
      - OCR_LANGS=eng+jpn+chi_sim
      - OCR_TIMEOUT_SEC=20
      - OCR_PSM=6
      - OCR_OEM=1
    restart: unless-stopped

  tts-en:
    image: dlaszlo/speech-service:cpu-latest
    container_name: trilingual-tts-en
    environment:
      - STT_MODEL_NAME=Systran/faster-distil-whisper-small.en
      - STT_COMPUTE_TYPE=int8
      - TTS_MODEL_NAME=hexgrad/Kokoro-82M
      - TTS_LANG_CODE=a
      - HF_HOME=/data/huggingface
    ports:
      - "8000:8000"
    volumes:
      - kokoro_cache:/data/huggingface
    restart: unless-stopped

  tts-ja:
    image: voicevox/voicevox_engine:latest
    container_name: trilingual-tts-ja
    # Apple Silicon 如拉取失败，可尝试指定 platform: linux/arm64
    ports:
      - "50021:50021"
    restart: unless-stopped

volumes:
  kokoro_cache:
  trilingual_records:
