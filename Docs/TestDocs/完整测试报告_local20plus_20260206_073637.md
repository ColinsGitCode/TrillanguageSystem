# Rebuild + Proxy透传 + 20+样本测试报告

- 报告时间: 2026-02-06
- 实验 ID: `exp_round_local20plus_20260206_073637`
- 样本规模: 21 条短语
- 轮次配置: `Docs/TestDocs/data/rounds_local_20plus_v1.json`

## 1. 环境重建结果

执行动作：
1. `docker compose down`
2. `docker compose up -d --build`

结果：
- `viewer`、`tts-en`、`tts-ja` 容器均成功启动。
- `viewer` 健康接口可访问：`/api/health` 返回正常服务状态。

## 2. gemini-host-proxy 透传验证

### 2.1 代码级变更点（已生效）

- `services/geminiProxyService.js`：请求体增加 `model` 字段。
- `scripts/gemini-host-proxy.js`：支持读取请求 `model`，并将 `--model <value>` 传给 CLI；响应返回 `model`。
- `server.js`：`GEMINI_MODE=host-proxy` 路径下将 `llm_model` 透传到 proxy。

### 2.2 硬验证（mock CLI）

使用临时 mock CLI 替代真实 `gemini` 命令，验证不同 `model` 入参是否被透传：

- 请求 1：`model=gemini-3-pro`
- 请求 2：`model=model-xyz-invalid`

返回中 `model` 字段与 mock 输出文本均准确反映请求值，说明 **proxy 的 model 透传机制已成立**。

### 2.3 真实链路现状

- `viewer -> host.docker.internal:3210/health` 可通。
- 真实 `gemini` 生成在当前宿主机环境存在不稳定（`/api/generate` 返回 500 / `fetch failed`），属于 CLI 运行环境问题，不是透传机制逻辑问题。

## 3. 20+ 样本实验结果（local baseline vs local few-shot）

### 3.0 数据口径说明

- 统计来源：`experiment_rounds` 与 `experiment_samples` 聚合结果。
- 样本范围：`Docs/TestDocs/data/phrases_round_21.txt` 共 21 条短语。
- 统计规则：失败样本按 `success=0` 记录，质量/Token/延迟按 0 参与均值，反映真实线上效果而非“仅成功样本效果”。
- 对比基线：`fewshot_r1` 所有增量指标均相对 `baseline` 计算。

## 3.1 轮次总览

| Round | 样本数 | 成功数 | 成功率 | 平均质量 | 平均Tokens | 平均延迟 |
|---|---:|---:|---:|---:|---:|---:|
| baseline | 21 | 19 | 90.48% | 72.00 | 979.76 | 57.59s |
| fewshot_r1 | 21 | 21 | 100.00% | 79.33 | 1498.48 | 59.16s |

## 3.2 KPI 结论

- 质量提升：`+7.33`（79.33 - 72.00）
- token 变化：`+518.71`（+52.94%）
- 延迟变化：`+1.57s`（+2.73%）
- 增益效率：`14.14 分 / 每 1k 额外 token`
- 作用判定：`fewshotEffectVisible = true`

补充说明：
- `增益效率` 计算方式：`Delta Quality / (Delta Tokens / 1000)`。
- 本轮说明 few-shot 能显著提质，但成本（Token）上升明显，仍需后续压缩提示词与示例长度。

## 3.3 few-shot 注入状态

- `few_shot_runs` 总计：40
- `fewshot_enabled=1`：21
- `example_count>0`：21

说明：few-shot 在本轮已实际注入，不是“启用但未命中示例”。

## 3.4 失败样本

baseline 轮有 2 条失败：
1. `吞吐量评估`：`fetch failed`
2. `多语言语义一致性`：`Failed to parse JSON response: output appears truncated...`

few-shot 轮 21/21 全成功。

## 3.5 指标释义（便于阅读图表）

- `Avg Quality`：该轮平均质量分（0~100，越高越好）。
- `Delta Quality`：相对 baseline 的质量变化，正值代表质量提升。
- `Avg Tokens`：该轮平均总 Token（输入+输出），越高表示成本越高。
- `Delta Tokens`：相对 baseline 的 Token 变化值。
- `Avg Latency`：该轮平均总耗时。
- `Gain / 1k Extra Tokens`：每增加 1000 个额外 Token 带来的质量增益。
- `fewshotEffectVisible`：是否观测到可识别的 few-shot 提升效果（布尔结论）。

## 4. 图表与解读

### 4.1 质量趋势图

![](charts/round_quality_trend_exp_round_local20plus_20260206_073637.svg)

说明：
- 横轴是轮次，纵轴是平均质量分。
- 该图用于回答“few-shot 是否提升质量”。
- 本轮从 `72.00` 提升到 `79.33`，提升明确。

### 4.2 增益与效率图（质量增益 + 每千 Token 收益）

![](charts/round_gain_efficiency_exp_round_local20plus_20260206_073637.svg)

说明：
- 柱状代表 `Delta Quality`，折线代表 `Gain / 1k Extra Tokens`。
- 该图用于回答“质量提升是否值得额外 Token 成本”。
- 本轮效率为 `14.14`，表明每 1k 额外 Token 可换来约 14 分质量提升。

### 4.3 对齐与稳定性图

![](charts/round_alignment_stability_exp_round_local20plus_20260206_073637.svg)

说明：
- 该图用于观察轮次稳定性（波动）及对齐变化。
- 本实验无 teacher 轮次，因此对齐率维度为空；主要用于看稳定性。
- 从 CV 角度看，few-shot 轮稳定性与 baseline 接近（3.40% vs 3.67%）。

### 4.4 质量-成本散点图

![](charts/round_gain_tokens_scatter_exp_round_local20plus_20260206_073637.svg)

说明：
- 横轴 `Delta Tokens`，纵轴 `Delta Quality`。
- 右上象限表示“增加成本并带来质量提升”。
- 本轮落在右上象限，说明当前 few-shot 配置是“增成本换提质”的有效区间。

## 5. 数据文件索引

- `Docs/TestDocs/data/round_trend_exp_round_local20plus_20260206_073637.json`
- `Docs/TestDocs/data/round_trend_exp_round_local20plus_20260206_073637.csv`
- `Docs/TestDocs/data/round_metrics_exp_round_local20plus_20260206_073637.csv`
- `Docs/TestDocs/data/round_deltas_exp_round_local20plus_20260206_073637.csv`
- `Docs/TestDocs/data/round_kpi_summary_exp_round_local20plus_20260206_073637.json`
- `Docs/TestDocs/fewshot_round_kpi_report_exp_round_local20plus_20260206_073637.md`

## 6. 结论

1. 容器重建与服务重启成功，测试环境可用。
2. `gemini-host-proxy` 的 `model` 透传能力已通过 mock 硬验证。
3. 在 21 条样本下，few-shot 明确提升本地 LLM 质量并提升稳定性（成功率从 90.48% 到 100%）。
4. 质量提升伴随 token 成本上升，需要在后续轮次继续优化示例长度与预算比例。
