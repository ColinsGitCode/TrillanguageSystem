<svg xmlns="http://www.w3.org/2000/svg" width="1600" height="920" style="background: rgb(248, 250, 252); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Noto Sans SC&quot;, sans-serif;"><rect x="20" y="20" width="1560" height="880" rx="20" fill="#ffffff" stroke="#e2e8f0"></rect><text x="56" y="72" font-size="44" font-weight="800" fill="#0f172a">学习卡片生成链路数据流程图（Gateway 18888）</text><text x="56" y="106" font-size="20" fill="#475569">主链路：UI -&gt; Viewer -&gt; Gateway(18888) -&gt; Host Executor(3210) -&gt; Gemini CLI -&gt; 后处理/TTS/存储</text><defs><marker id="arrow" viewBox="0 -5 10 10" refX="9" refY="0" markerWidth="8" markerHeight="8" orient="auto"><path d="M0,-5L10,0L0,5" fill="#64748b"></path></marker><marker id="arrow-red" viewBox="0 -5 10 10" refX="9" refY="0" markerWidth="8" markerHeight="8" orient="auto"><path d="M0,-5L10,0L0,5" fill="#dc2626"></path></marker></defs><rect x="60" y="180" width="220" height="120" rx="14" fill="#e0f2fe" stroke="#0284c7" stroke-width="2.4"></rect><text x="78" y="218" font-size="26" font-weight="800" fill="#0f172a">前端 UI</text><text x="78" y="254" font-size="18" fill="#1e293b">文本输入 / OCR 输入</text><rect x="330" y="170" width="270" height="140" rx="14" fill="#dbeafe" stroke="#2563eb" stroke-width="2.4"></rect><text x="348" y="208" font-size="26" font-weight="800" fill="#0f172a">Viewer 服务 :3010</text><text x="348" y="244" font-size="18" fill="#1e293b">server.js 编排</text><text x="348" y="272" font-size="18" fill="#1e293b">/api/generate</text><rect x="650" y="170" width="280" height="140" rx="14" fill="#ede9fe" stroke="#7c3aed" stroke-width="2.4"></rect><text x="668" y="208" font-size="26" font-weight="800" fill="#0f172a">Gemini Gateway :18888</text><text x="668" y="244" font-size="18" fill="#1e293b">鉴权 / 队列 / 熔断</text><text x="668" y="272" font-size="18" fill="#1e293b">/api/gemini</text><rect x="980" y="170" width="280" height="140" rx="14" fill="#dcfce7" stroke="#16a34a" stroke-width="2.4"></rect><text x="998" y="208" font-size="26" font-weight="800" fill="#0f172a">Host Executor :3210</text><text x="998" y="244" font-size="18" fill="#1e293b">gemini-host-proxy.js</text><text x="998" y="272" font-size="18" fill="#1e293b">执行器</text><rect x="1310" y="170" width="230" height="140" rx="14" fill="#ffedd5" stroke="#ea580c" stroke-width="2.4"></rect><text x="1328" y="208" font-size="26" font-weight="800" fill="#0f172a">Gemini CLI</text><text x="1328" y="244" font-size="18" fill="#1e293b">gemini --model</text><text x="1328" y="272" font-size="18" fill="#1e293b">-p prompt</text><rect x="360" y="420" width="290" height="150" rx="14" fill="#f1f5f9" stroke="#64748b" stroke-width="2.4"></rect><text x="378" y="458" font-size="26" font-weight="800" fill="#0f172a">后处理/渲染</text><text x="378" y="494" font-size="18" fill="#1e293b">contentPostProcessor</text><text x="378" y="522" font-size="18" fill="#1e293b">htmlRenderer + 注音/音频任务</text><rect x="700" y="420" width="260" height="150" rx="14" fill="#fef3c7" stroke="#ca8a04" stroke-width="2.4"></rect><text x="718" y="458" font-size="26" font-weight="800" fill="#0f172a">TTS 服务</text><text x="718" y="494" font-size="18" fill="#1e293b">EN: :8000</text><text x="718" y="522" font-size="18" fill="#1e293b">JA: :50021</text><rect x="1010" y="420" width="260" height="150" rx="14" fill="#e0f2fe" stroke="#0284c7" stroke-width="2.4"></rect><text x="1028" y="458" font-size="26" font-weight="800" fill="#0f172a">文件存储</text><text x="1028" y="494" font-size="18" fill="#1e293b">/data/trilingual_records</text><text x="1028" y="522" font-size="18" fill="#1e293b">md/html/wav/meta</text><rect x="1320" y="420" width="220" height="150" rx="14" fill="#fee2e2" stroke="#dc2626" stroke-width="2.4"></rect><text x="1338" y="458" font-size="26" font-weight="800" fill="#0f172a">SQLite</text><text x="1338" y="494" font-size="18" fill="#1e293b">generations</text><text x="1338" y="522" font-size="18" fill="#1e293b">observability_metrics</text><rect x="60" y="650" width="310" height="170" rx="14" fill="#fee2e2" stroke="#dc2626" stroke-width="2.4"></rect><text x="78" y="688" font-size="26" font-weight="800" fill="#0f172a">异常分支</text><text x="78" y="724" font-size="18" fill="#1e293b">Gateway 503 / breaker open</text><text x="78" y="752" font-size="18" fill="#1e293b">或 Local LLM 不可达</text><text x="78" y="780" font-size="18" fill="#1e293b">最终写入 generation_errors</text><line x1="280" y1="240" x2="330" y2="240" stroke="#64748b" stroke-width="2.2" marker-end="url(#arrow)"></line><text x="305" y="230" text-anchor="middle" font-size="16" fill="#475569">POST /api/generate</text><line x1="600" y1="240" x2="650" y2="240" stroke="#64748b" stroke-width="2.2" marker-end="url(#arrow)"></line><text x="625" y="230" text-anchor="middle" font-size="16" fill="#475569">llm_provider=gemini</text><line x1="930" y1="240" x2="980" y2="240" stroke="#64748b" stroke-width="2.2" marker-end="url(#arrow)"></line><text x="955" y="230" text-anchor="middle" font-size="16" fill="#475569">上游转发</text><line x1="1260" y1="240" x2="1310" y2="240" stroke="#64748b" stroke-width="2.2" marker-end="url(#arrow)"></line><text x="1285" y="230" text-anchor="middle" font-size="16" fill="#475569">spawn CLI</text><line x1="1420" y1="310" x2="510" y2="420" stroke="#64748b" stroke-width="2.2" marker-end="url(#arrow)"></line><text x="965" y="355" text-anchor="middle" font-size="16" fill="#475569">markdown/rawOutput 回传</text><line x1="650" y1="495" x2="700" y2="495" stroke="#64748b" stroke-width="2.2" marker-end="url(#arrow)"></line><text x="675" y="485" text-anchor="middle" font-size="16" fill="#475569">抽取 audio_tasks</text><line x1="960" y1="495" x2="1010" y2="495" stroke="#64748b" stroke-width="2.2" marker-end="url(#arrow)"></line><text x="985" y="485" text-anchor="middle" font-size="16" fill="#475569">保存卡片文件</text><line x1="1270" y1="495" x2="1320" y2="495" stroke="#64748b" stroke-width="2.2" marker-end="url(#arrow)"></line><text x="1295" y="485" text-anchor="middle" font-size="16" fill="#475569">落库指标与记录</text><line x1="790" y1="310" x2="210" y2="650" stroke="#dc2626" stroke-width="2.2" stroke-dasharray="8,6" marker-end="url(#arrow-red)"></line><text x="500" y="470" text-anchor="middle" font-size="16" fill="#b91c1c">上游失败/熔断</text><line x1="370" y1="735" x2="330" y2="250" stroke="#dc2626" stroke-width="2.2" stroke-dasharray="8,6" marker-end="url(#arrow-red)"></line><text x="350" y="482.5" text-anchor="middle" font-size="16" fill="#b91c1c">回退失败后报错</text><rect x="420" y="650" width="1120" height="170" rx="14" fill="#f8fafc" stroke="#cbd5e1" stroke-dasharray="6,5"></rect><text x="446" y="690" font-size="24" font-weight="700" fill="#0f172a">运维要点（当前工程）</text><text x="446" y="730" font-size="18" fill="#334155">1) 18888 是入口端口；是否可用取决于 Gateway -&gt; 3210 -&gt; Gemini CLI 全链路。</text><text x="446" y="760" font-size="18" fill="#334155">2) /health 在线不代表 /api/gemini 可用；需同时看 breaker_state 与上游连通性。</text><text x="446" y="790" font-size="18" fill="#334155">3) 建议保留 GEMINI_PROXY_URL 可配置，故障时可快速切换到直连可达执行器。</text><text x="56" y="878" font-size="14" fill="#64748b">Source: server.js / geminiProxyService.js / gemini-host-proxy.js / Gateway18888 runtime</text></svg>