<svg xmlns="http://www.w3.org/2000/svg" width="1600" height="980" style="background-color: rgb(255, 255, 255);"><defs><marker id="arrow" viewBox="0 -5 10 10" refX="8" refY="0" markerWidth="7" markerHeight="7" orient="auto"><path d="M0,-5L10,0L0,5" fill="#475569"></path></marker><filter id="softShadow" x="-20%" y="-20%" width="160%" height="160%"><feDropShadow dx="0" dy="2" stdDeviation="2.2" flood-color="#0f172a" flood-opacity="0.12"></feDropShadow></filter></defs><text x="42" y="44" font-size="30" font-weight="800" fill="#0f172a">Code-as-Prompt 机制架构图（V1 / V2 / V3）</text><text x="42" y="72" font-size="15" font-weight="500" fill="#64748b">Static Template -&gt; Programmatic Assembly -&gt; Runtime Few-shot Injection</text><rect x="30" y="100" width="500" height="620" rx="16" fill="#f8fafc" stroke="#cbd5e1" stroke-width="1.8" stroke-dasharray="6,6"></rect><rect x="44" y="112" width="472" height="42" rx="10" fill="#e0f2fe" stroke="#0284c7" stroke-width="2.2"></rect><text x="58" y="140" font-size="20" font-weight="800" fill="#0f172a">V1 静态模板层</text><rect x="550" y="100" width="500" height="620" rx="16" fill="#f8fafc" stroke="#cbd5e1" stroke-width="1.8" stroke-dasharray="6,6"></rect><rect x="564" y="112" width="472" height="42" rx="10" fill="#fef3c7" stroke="#d97706" stroke-width="2.2"></rect><text x="578" y="140" font-size="20" font-weight="800" fill="#0f172a">V2 程序化生成层</text><rect x="1070" y="100" width="500" height="620" rx="16" fill="#f8fafc" stroke="#cbd5e1" stroke-width="1.8" stroke-dasharray="6,6"></rect><rect x="1084" y="112" width="472" height="42" rx="10" fill="#dcfce7" stroke="#16a34a" stroke-width="2.2"></rect><text x="1098" y="140" font-size="20" font-weight="800" fill="#0f172a">V3 动态注入层</text><g><rect x="58" y="185" width="445" height="100" rx="12" fill="#e0f2fe" stroke="#0284c7" stroke-width="2" filter="url(#softShadow)"></rect><text x="72" y="209" font-size="14" font-weight="600" fill="#1f2937"><tspan x="72" dy="0">prompts/phrase_3LANS_markdown.md</tspan><tspan x="72" dy="18">固定结构与字段命名规则</tspan><tspan x="72" dy="18">占位符替换: {{ phrase }}</tspan></text></g><g><rect x="58" y="315" width="445" height="100" rx="12" fill="#e0f2fe" stroke="#0284c7" stroke-width="2" filter="url(#softShadow)"></rect><text x="72" y="339" font-size="14" font-weight="600" fill="#1f2937"><tspan x="72" dy="0">services/promptEngine.js</tspan><tspan x="72" dy="18">buildPrompt() strictCompactPrompt</tspan><tspan x="72" dy="18">JSON 输出模板 (静态规则)</tspan></text></g><g><rect x="578" y="185" width="445" height="100" rx="12" fill="#fef3c7" stroke="#d97706" stroke-width="2" filter="url(#softShadow)"></rect><text x="592" y="209" font-size="14" font-weight="600" fill="#1f2937"><tspan x="592" dy="0">server.js generateWithProvider()</tspan><tspan x="592" dy="18">按 provider/mode 选择 prompt</tspan><tspan x="592" dy="18">buildPrompt / buildMarkdownPrompt</tspan></text></g><g><rect x="578" y="315" width="445" height="110" rx="12" fill="#fef3c7" stroke="#d97706" stroke-width="2" filter="url(#softShadow)"></rect><text x="592" y="339" font-size="14" font-weight="600" fill="#1f2937"><tspan x="592" dy="0">fewshotOptions 参数化配置</tspan><tspan x="592" dy="18">count/minScore/contextWindow/tokenBudgetRatio</tspan><tspan x="592" dy="18">请求级实验参数注入</tspan></text></g><g><rect x="578" y="457" width="445" height="110" rx="12" fill="#ede9fe" stroke="#7c3aed" stroke-width="2" filter="url(#softShadow)"></rect><text x="592" y="481" font-size="14" font-weight="600" fill="#1f2937"><tspan x="592" dy="0">observability PromptParser</tspan><tspan x="592" dy="18">prompt 结构化解析 + token 估算</tspan><tspan x="592" dy="18">保存 prompt/rawOutput/metadata</tspan></text></g><g><rect x="1098" y="185" width="445" height="120" rx="12" fill="#dcfce7" stroke="#16a34a" stroke-width="2" filter="url(#softShadow)"></rect><text x="1112" y="209" font-size="14" font-weight="600" fill="#1f2937"><tspan x="1112" dy="0">goldenExamplesService.getRelevantExamples()</tspan><tspan x="1112" dy="18">Teacher 优先 -&gt; 历史高质量回退</tspan><tspan x="1112" dy="18">bigramSimilarity 重排候选</tspan></text></g><g><rect x="1098" y="337" width="445" height="110" rx="12" fill="#fee2e2" stroke="#dc2626" stroke-width="2" filter="url(#softShadow)"></rect><text x="1112" y="361" font-size="14" font-weight="600" fill="#1f2937"><tspan x="1112" dy="0">预算门控 (server.js)</tspan><tspan x="1112" dy="18">budget_reduction / budget_truncate</tspan><tspan x="1112" dy="18">budget_exceeded_disable</tspan></text></g><g><rect x="1098" y="479" width="445" height="100" rx="12" fill="#dcfce7" stroke="#16a34a" stroke-width="2" filter="url(#softShadow)"></rect><text x="1112" y="503" font-size="14" font-weight="600" fill="#1f2937"><tspan x="1112" dy="0">buildEnhancedPrompt()</tspan><tspan x="1112" dy="18">Few-shot 示例拼接到 basePrompt</tspan><tspan x="1112" dy="18">最终提交给 LLM</tspan></text></g><g><rect x="140" y="760" width="1320" height="160" rx="16" fill="#eef2ff" stroke="#4f46e5" stroke-width="2.6" filter="url(#softShadow)"></rect><text x="154" y="784" font-size="15" font-weight="600" fill="#1f2937"><tspan x="154" dy="0">观测与实验闭环: few_shot_runs / few_shot_examples / experiment_rounds / experiment_samples / teacher_references</tspan><tspan x="154" dy="18">运行脚本: scripts/run_fewshot_rounds.js -&gt; scripts/export_round_trend_dataset.js -&gt; 报告图表</tspan><tspan x="154" dy="18">目标: Prompt 优化从“文本改写”升级为“代码重构 + 可追踪实验迭代”</tspan></text></g><line x1="503" y1="235" x2="578" y2="235" stroke="#475569" stroke-width="1.8" marker-end="url(#arrow)"></line><text x="540.5" y="229" text-anchor="middle" font-size="12" font-weight="600" fill="#334155">模板输入</text><line x1="1023" y1="240" x2="1098" y2="240" stroke="#475569" stroke-width="1.8" marker-end="url(#arrow)"></line><text x="1060.5" y="234" text-anchor="middle" font-size="12" font-weight="600" fill="#334155">运行时增强</text><line x1="800" y1="567" x2="800" y2="760" stroke="#475569" stroke-width="1.8" marker-end="url(#arrow)"></line><text x="800" y="657.5" text-anchor="middle" font-size="12" font-weight="600" fill="#334155">观测数据沉淀</text><line x1="1318" y1="579" x2="1318" y2="760" stroke="#475569" stroke-width="1.8" marker-end="url(#arrow)"></line><text x="1318" y="663.5" text-anchor="middle" font-size="12" font-weight="600" fill="#334155">few-shot 元数据</text><text x="42" y="955" font-size="12" fill="#64748b">Source: promptEngine.js, server.js, goldenExamplesService.js, observabilityService.js</text></svg>