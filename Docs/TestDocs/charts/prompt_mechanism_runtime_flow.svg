<svg xmlns="http://www.w3.org/2000/svg" width="1600" height="1020" style="background-color: rgb(255, 255, 255);"><defs><marker id="arrow" viewBox="0 -5 10 10" refX="8" refY="0" markerWidth="7" markerHeight="7" orient="auto"><path d="M0,-5L10,0L0,5" fill="#475569"></path></marker><filter id="softShadow" x="-20%" y="-20%" width="160%" height="160%"><feDropShadow dx="0" dy="2" stdDeviation="2.2" flood-color="#0f172a" flood-opacity="0.12"></feDropShadow></filter></defs><text x="42" y="44" font-size="30" font-weight="800" fill="#0f172a">Code-as-Prompt 运行流程图（请求到实验回归）</text><text x="42" y="72" font-size="15" font-weight="500" fill="#64748b">请求驱动 -&gt; Prompt 组装 -&gt; Few-shot 注入 -&gt; 预算门控 -&gt; 观测回写</text><g><rect x="120" y="140" width="300" height="128" rx="12" fill="#e0f2fe" stroke="#0284c7" stroke-width="2" filter="url(#softShadow)"></rect><text x="134" y="164" font-size="14" font-weight="600" fill="#1f2937"><tspan x="134" dy="0">1. API 请求进入</tspan><tspan x="134" dy="18">POST /api/generate</tspan><tspan x="134" dy="18">携带 fewshot_options</tspan></text></g><g><rect x="470" y="140" width="300" height="128" rx="12" fill="#fef3c7" stroke="#d97706" stroke-width="2" filter="url(#softShadow)"></rect><text x="484" y="164" font-size="14" font-weight="600" fill="#1f2937"><tspan x="484" dy="0">2. 选择基础 Prompt</tspan><tspan x="484" dy="18">buildPrompt / buildMarkdownPrompt</tspan><tspan x="484" dy="18">按 provider/mode 分流</tspan></text></g><g><rect x="820" y="140" width="300" height="128" rx="12" fill="#fef3c7" stroke="#d97706" stroke-width="2" filter="url(#softShadow)"></rect><text x="834" y="164" font-size="14" font-weight="600" fill="#1f2937"><tspan x="834" dy="0">3. 判断 few-shot</tspan><tspan x="834" dy="18">provider=local &amp;&amp; enabled</tspan><tspan x="834" dy="18">读取策略参数</tspan></text></g><g><rect x="1170" y="140" width="300" height="128" rx="12" fill="#dcfce7" stroke="#16a34a" stroke-width="2" filter="url(#softShadow)"></rect><text x="1184" y="164" font-size="14" font-weight="600" fill="#1f2937"><tspan x="1184" dy="0">4. 示例检索</tspan><tspan x="1184" dy="18">teacher_references 优先</tspan><tspan x="1184" dy="18">历史高质量 + bigram</tspan></text></g><g><rect x="1170" y="330" width="300" height="128" rx="12" fill="#fee2e2" stroke="#dc2626" stroke-width="2" filter="url(#softShadow)"></rect><text x="1184" y="354" font-size="14" font-weight="600" fill="#1f2937"><tspan x="1184" dy="0">5. 预算门控</tspan><tspan x="1184" dy="18">reduction -&gt; truncate</tspan><tspan x="1184" dy="18">超限则 disable</tspan></text></g><g><rect x="820" y="330" width="300" height="128" rx="12" fill="#dcfce7" stroke="#16a34a" stroke-width="2" filter="url(#softShadow)"></rect><text x="834" y="354" font-size="14" font-weight="600" fill="#1f2937"><tspan x="834" dy="0">6. 生成增强 Prompt</tspan><tspan x="834" dy="18">buildEnhancedPrompt(base, examples)</tspan><tspan x="834" dy="18">得到最终 prompt</tspan></text></g><g><rect x="470" y="330" width="300" height="128" rx="12" fill="#fef3c7" stroke="#d97706" stroke-width="2" filter="url(#softShadow)"></rect><text x="484" y="354" font-size="14" font-weight="600" fill="#1f2937"><tspan x="484" dy="0">7. 调用模型</tspan><tspan x="484" dy="18">local / gemini gateway</tspan><tspan x="484" dy="18">获取输出 + usage</tspan></text></g><g><rect x="120" y="330" width="300" height="128" rx="12" fill="#e0f2fe" stroke="#0284c7" stroke-width="2" filter="url(#softShadow)"></rect><text x="134" y="354" font-size="14" font-weight="600" fill="#1f2937"><tspan x="134" dy="0">8. 后处理与渲染</tspan><tspan x="134" dy="18">validate + render HTML</tspan><tspan x="134" dy="18">抽取 audio_tasks</tspan></text></g><g><rect x="120" y="560" width="300" height="128" rx="12" fill="#ede9fe" stroke="#7c3aed" stroke-width="2" filter="url(#softShadow)"></rect><text x="134" y="584" font-size="14" font-weight="600" fill="#1f2937"><tspan x="134" dy="0">9. 文件与数据库落地</tspan><tspan x="134" dy="18">generations + observability</tspan><tspan x="134" dy="18">few_shot_runs/examples</tspan></text></g><g><rect x="470" y="560" width="300" height="128" rx="12" fill="#ede9fe" stroke="#7c3aed" stroke-width="2" filter="url(#softShadow)"></rect><text x="484" y="584" font-size="14" font-weight="600" fill="#1f2937"><tspan x="484" dy="0">10. 实验样本追踪</tspan><tspan x="484" dy="18">experiment_samples</tspan><tspan x="484" dy="18">teacher_references</tspan></text></g><g><rect x="820" y="560" width="300" height="128" rx="12" fill="#ede9fe" stroke="#7c3aed" stroke-width="2" filter="url(#softShadow)"></rect><text x="834" y="584" font-size="14" font-weight="600" fill="#1f2937"><tspan x="834" dy="0">11. 指标导出</tspan><tspan x="834" dy="18">export_round_trend_dataset</tspan><tspan x="834" dy="18">CSV/JSON/KPI</tspan></text></g><g><rect x="1170" y="560" width="300" height="128" rx="12" fill="#dcfce7" stroke="#16a34a" stroke-width="2" filter="url(#softShadow)"></rect><text x="1184" y="584" font-size="14" font-weight="600" fill="#1f2937"><tspan x="1184" dy="0">12. 报告图表回归</tspan><tspan x="1184" dy="18">D3 SVG + 测试报告</tspan><tspan x="1184" dy="18">形成下一轮 prompt 优化</tspan></text></g><line x1="420" y1="204" x2="470" y2="204" stroke="#475569" stroke-width="1.8" marker-end="url(#arrow)"></line><text x="445" y="198" text-anchor="middle" font-size="12" font-weight="600" fill="#334155">request</text><line x1="770" y1="204" x2="820" y2="204" stroke="#475569" stroke-width="1.8" marker-end="url(#arrow)"></line><text x="795" y="198" text-anchor="middle" font-size="12" font-weight="600" fill="#334155">base prompt</text><line x1="1120" y1="204" x2="1170" y2="204" stroke="#475569" stroke-width="1.8" marker-end="url(#arrow)"></line><text x="1145" y="198" text-anchor="middle" font-size="12" font-weight="600" fill="#334155">few-shot on</text><line x1="1320" y1="268" x2="1320" y2="330" stroke="#475569" stroke-width="1.8" marker-end="url(#arrow)"></line><text x="1320" y="293" text-anchor="middle" font-size="12" font-weight="600" fill="#334155">candidate examples</text><line x1="1170" y1="394" x2="1120" y2="394" stroke="#475569" stroke-width="1.8" marker-end="url(#arrow)"></line><text x="1145" y="388" text-anchor="middle" font-size="12" font-weight="600" fill="#334155">budget pass</text><line x1="820" y1="394" x2="770" y2="394" stroke="#475569" stroke-width="1.8" marker-end="url(#arrow)"></line><text x="795" y="388" text-anchor="middle" font-size="12" font-weight="600" fill="#334155">enhanced prompt</text><line x1="470" y1="394" x2="420" y2="394" stroke="#475569" stroke-width="1.8" marker-end="url(#arrow)"></line><text x="445" y="388" text-anchor="middle" font-size="12" font-weight="600" fill="#334155">model output</text><line x1="270" y1="458" x2="270" y2="560" stroke="#475569" stroke-width="1.8" marker-end="url(#arrow)"></line><text x="270" y="503" text-anchor="middle" font-size="12" font-weight="600" fill="#334155">parsed content</text><line x1="420" y1="624" x2="470" y2="624" stroke="#475569" stroke-width="1.8" marker-end="url(#arrow)"></line><text x="445" y="618" text-anchor="middle" font-size="12" font-weight="600" fill="#334155">metrics</text><line x1="770" y1="624" x2="820" y2="624" stroke="#475569" stroke-width="1.8" marker-end="url(#arrow)"></line><text x="795" y="618" text-anchor="middle" font-size="12" font-weight="600" fill="#334155">experiment trend</text><line x1="1120" y1="624" x2="1170" y2="624" stroke="#475569" stroke-width="1.8" marker-end="url(#arrow)"></line><text x="1145" y="618" text-anchor="middle" font-size="12" font-weight="600" fill="#334155">report artifacts</text><line x1="1320" y1="688" x2="1320" y2="820" stroke="#475569" stroke-width="1.8" marker-end="url(#arrow)"></line><text x="1320" y="748" text-anchor="middle" font-size="12" font-weight="600" fill="#334155">feedback</text><line x1="1320" y1="820" x2="180" y2="820" stroke="#475569" stroke-width="1.8" marker-end="url(#arrow)"></line><line x1="180" y1="820" x2="180" y2="268" stroke="#475569" stroke-width="1.8" marker-end="url(#arrow)"></line><text x="180" y="538" text-anchor="middle" font-size="12" font-weight="600" fill="#334155">next round</text><rect x="80" y="860" width="1440" height="120" rx="14" fill="#f8fafc" stroke="#94a3b8" stroke-width="1.8"></rect><text x="110" y="900" font-size="15" font-weight="600" fill="#334155"><tspan x="110" dy="0">关键控制点: few-shot 仅在 local provider 启用；teacher 样本优先；预算超限会自动降级/禁用，保证请求可用性。</tspan><tspan x="110" dy="28">关键输出: prompt/full/rawOutput/fewShotMeta 全量入库，可直接用于统计检验与版本回归。</tspan></text><text x="42" y="1000" font-size="12" fill="#64748b">Source: server.js (generateWithProvider), goldenExamplesService.js, fewShotMetricsService.js, experimentTrackingService.js</text></svg>