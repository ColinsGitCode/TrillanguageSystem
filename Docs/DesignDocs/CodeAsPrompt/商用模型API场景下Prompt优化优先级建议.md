# 商用模型 API 场景下 Prompt 优化优先级建议

## 1. 目标与范围
- 目标：在**不改模型权重**前提下，提升学习卡片生成质量与稳定性。
- 范围：仅讨论 Prompt Engineering / Code as Prompt 层面的可落地机制。
- 评价基线：质量（Quality/Success）+ 约束（Tokens/Latency）+ 统计显著性（p-value/Cohen's d）。

---

## 2. 哪些机制对商用 API 提升最明显（按实战收益排序）

### P1. 分层检索增强 Few-shot（高质量 Teacher 样本池）
- 作用：显著提升术语一致性、例句质量、风格稳定性。
- 关键：不是只做相似度检索，要叠加错误类型/场景标签进行样本注入。
- 典型收益：质量分提升最直接，且可持续复用。

### P2. Schema-First + 校验/修复循环（Validator Loop）
- 作用：显著提升结构正确率、字段完整率、解析成功率。
- 关键：先强约束输出结构，再做定点修复重试（而非整段重生）。
- 典型收益：稳定性提升最明显，线上事故率下降。

### P3. 任务路由 Prompt（文本/OCR/对比模式分路）
- 作用：提升首轮命中率，降低复杂输入（OCR 噪声、混语）失效率。
- 关键：按输入类型与噪声等级切模板，不使用“一个大 Prompt 打天下”。
- 典型收益：复杂场景收益明显，平均 token 更可控。

### P4. 两阶段生成（Draft -> Normalize）
- 作用：兼顾语义质量与结构规范，降低幻觉与格式错位。
- 关键：第一阶段只管内容，第二阶段只管规范化与术语对齐。
- 典型收益：中高收益，适合严谨输出场景。

### P5. Best-of-N + 轻量重排（N=2~3）
- 作用：质量上限提升明显。
- 关键：仅对关键请求启用，避免全量放大 token 与延迟成本。
- 典型收益：质量提升强，但成本增幅也最大。

---

## 3. 在本工程中的优先落地顺序（推荐）
1. **Schema-First + 修复循环（P2）**
2. **分层 Few-shot（P1）**
3. **任务路由 Prompt（P3）**
4. 两阶段生成（P4）
5. Best-of-N（P5，按需开关）

> 推荐先做 1/2/3：通常能取得“高收益 + 可控成本 + 快速验证”的平衡。

---

## 4. 每项机制的验证指标（建议）

### P1 分层 Few-shot
- 主指标：Quality Score、Teacher Gap、Success Rate
- 约束指标：Avg Tokens、Latency
- 效率指标：Gain per 1k Tokens

### P2 Schema + 修复循环
- 主指标：解析成功率、字段完整率、格式合规率
- 约束指标：重试次数、单次重试 token
- 稳定性：失败类型分布是否收敛

### P3 任务路由 Prompt
- 主指标：按场景分桶成功率（文本/OCR/对比）
- 约束指标：各桶平均 tokens/latency
- 稳定性：高噪声 OCR 场景的错误率下降

### P4 两阶段生成
- 主指标：语义错误率、结构错误率
- 约束指标：双阶段总 token、总时延
- 统计：与单阶段对照的显著性

### P5 Best-of-N
- 主指标：最优候选质量提升幅度
- 约束指标：token 与 latency 的放大量
- 决策：仅保留 ROI 为正的业务入口

---

## 5. 实施注意事项
- 必须保留可回滚开关：`fewshot_enabled`、`route_prompt_enabled`、`best_of_n_enabled`。
- 所有实验统一使用同一基线集，避免样本漂移导致假提升。
- 采用“先小流量验证 -> 再扩大样本”策略，避免一次性全量切换。
- 任何优化结论都应附带统计结论（p-value + effect size），避免仅看均值。

